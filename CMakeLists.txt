cmake_minimum_required(VERSION 3.10)

project(nightingale C ASM)

unset(CMAKE_SYSROOT)
set(CMAKE_INSTALL_PREFIX ${CMAKE_BINARY_DIR}/sysroot)
set(CMAKE_SYSROOT ${CMAKE_BINARY_DIR}/sysroot)
set(CMAKE_ASM_COMPILER clang)
set(CMAKE_ASM_COMPILER_TARGET x86_64-unknown-none)
set(CMAKE_C_COMPILER clang)
set(CMAKE_C_COMPILER_TARGET x86_64-unknown-none)
set(CMAKE_CXX_COMPILER clang++)
set(CMAKE_CXX_COMPILER_TARGET x86_64-unknown-none)
set(CMAKE_LINKER ld.lld)
set(CMAKE_C_LINK_EXECUTABLE "<CMAKE_LINKER> <CMAKE_C_LINK_FLAGS> <LINK_FLAGS> <OBJECTS> -o <TARGET> <LINK_LIBRARIES>")

set(CMAKE_TRY_COMPILE_TARGET_TYPE STATIC_LIBRARY)

# TODO: replace this with a generated header - should play better with rebuilds
execute_process(
    COMMAND git describe --tags
    WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
    OUTPUT_VARIABLE NIGHTINGALE_VERSION
    OUTPUT_STRIP_TRAILING_WHITESPACE
)

list(APPEND AUTOGENERATED_HEADERS
    ${CMAKE_BINARY_DIR}/autogenerated_errnos.h
    ${CMAKE_BINARY_DIR}/autogenerated_syscall_consts.h
    ${CMAKE_BINARY_DIR}/autogenerated_syscalls_kernel.h
    ${CMAKE_BINARY_DIR}/autogenerated_syscalls_user.h
    ${CMAKE_BINARY_DIR}/autogenerated_errnos.c
    ${CMAKE_BINARY_DIR}/autogenerated_syscall_names.c
    ${CMAKE_BINARY_DIR}/autogenerated_syscalls_kernel.c
    ${CMAKE_BINARY_DIR}/autogenerated_syscalls_user.c
)

add_custom_command(
    OUTPUT ${AUTOGENERATED_HEADERS}
    COMMAND ${CMAKE_SOURCE_DIR}/script/generate_syscalls.rb ${CMAKE_BINARY_DIR}
    DEPENDS ${CMAKE_SOURCE_DIR}/script/generate_syscalls.rb
    MAIN_DEPENDENCY interface/SYSCALLS interface/ERRNOS
    WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
)

set_source_files_properties(${AUTOGENERATED_HEADERS} PROPERTIES GENERATED 1)

add_custom_target(generate_headers DEPENDS ${AUTOGENERATED_HEADERS})

add_compile_options(
    -std=c11
    -Wall
    -Wextra
    -Werror
    -pedantic
    -g
    -O2
    -D__nightingale__=1
    -ffreestanding
    -nostdlib
    -Wno-unused-variable
    -Wno-unused-parameter
    -Wno-unused-function
    -Wno-sign-compare
    -Wno-address-of-packed-member
)

set(CMAKE_EXE_LINKER_FLAGS "-static")

include_directories(${CMAKE_BINARY_DIR})
include_directories(include)

add_subdirectory(kernel)
add_subdirectory(libc)
add_subdirectory(linker)
add_subdirectory(user)

add_dependencies(nightingale_kernel generate_headers)
add_dependencies(c generate_headers)
add_dependencies(elf generate_headers)

install(DIRECTORY include DESTINATION ${CMAKE_INSTALL_PREFIX})
